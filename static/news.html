<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‰´ìŠ¤ ê¸°ë°˜ í–‰ì•ˆìœ„ ì•ˆê±´ í›„ë³´ ë¸Œë¦¬í•‘</title>
  <style>
    /* ====== (ê¸°ì¡´ index.html ìŠ¤íƒ€ì¼ì„ ìµœëŒ€í•œ ìœ ì§€) ====== */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      background-color: #f5f7fa;
      color: #333;
      padding: 20px;
    }

    .header {
      background-color: white;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .header-left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .brand{
      font-weight:900; font-size:16px; color:#111; text-decoration:none;
      padding:8px 10px; border-radius:10px;
      border:1px solid #e6e6e6; background:#fff;
    }
    .nav{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .navBtn{
      text-decoration:none;
      padding:8px 10px; border-radius:10px;
      border:1px solid #ddd; background:#fff;
      font-weight:800; font-size:13px; color:#111;
    }
    .navBtn.active{ background:#1a1a1a; color:#fff; border-color:#1a1a1a; }

    /* âœ… ìƒë‹¨ ê¸°ì¤€ ì‹œê°„ í‘œì‹œ */
    .asof{
      margin-left: 6px;
      font-size: 12px;
      color: #666;
      font-weight: 700;
    }

    .header-title { font-size: 24px; font-weight: bold; color: #1a1a1a; }

    .header-controls { display: flex; gap: 10px; align-items: center; }

    .search-box { display: flex; gap: 10px; align-items: center; }

    .search-input {
      padding: 8px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 340px;
      font-size: 14px;
    }

    .search-btn {
      padding: 8px 20px;
      background-color: #4a90e2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .search-btn:hover { background-color: #357abd; }

    .content-area { display: flex; gap: 20px; }

    .main-content { flex: 1; }

    .sidebar {
      width: 280px;
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #1a1a1a;
    }

    .sidebar-item {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
      border-left: 3px solid #2ed573;
    }
    .sidebar-item:hover { background-color: #f0f4f8; }

    .tag-section { margin-top: 25px; }

    .tag {
      display: inline-block;
      padding: 5px 12px;
      background-color: #e8f0fe;
      color: #1967d2;
      border-radius: 20px;
      font-size: 12px;
      margin: 4px;
      cursor: pointer;
      user-select: none;
    }
    .tag.active { background-color: #1967d2; color: #fff; }

    .issue-card {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      overflow: hidden;
      transition: box-shadow 0.3s;
    }
    .issue-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }

    .issue-header {
      padding: 20px 25px;
      border-bottom: 1px solid #e8eaed;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .issue-title-section { flex: 1; min-width: 0; }

    /* âœ… meta ì˜ì—­ì€ ë‚¨ê²¨ë‘ë˜(ë ˆì´ì•„ì›ƒ ì•ˆì •), ë°°ì§€ëŠ” ì œê±°ë¨ */
    .issue-meta {
      display: flex;
      gap: 12px;
      margin-bottom: 10px;
      align-items: center;
      flex-wrap: wrap;
      min-height: 0;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    .badge.blue { background-color: #4a90e2; }
    .badge.gray { background-color: #6c757d; }
    .badge.green { background-color: #2ed573; }
    .badge.orange { background-color: #ffa502; }
    .badge.red { background-color: #ff4757; }

    .issue-title {
      font-size: 18px;
      font-weight: bold;
      color: #1a1a1a;
      margin-bottom: 2px;
      line-height: 1.35;
      word-break: keep-all;
    }

    .issue-subtitle {
      font-size: 13px;
      color: #666;
      line-height: 1.35;
      margin-top: 6px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .expand-icon {
      font-size: 20px;
      color: #666;
      transition: transform 0.3s;
      flex: 0 0 auto;
    }
    .expand-icon.expanded { transform: rotate(180deg); }

    .issue-body {
      padding: 0 25px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }
    .issue-body.expanded { max-height: 5000px; padding: 20px 25px; }

    .section-title {
      font-size: 15px;
      font-weight: bold;
      color: #1a1a1a;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-icon { font-size: 18px; }

    .summary-section { margin-bottom: 25px; }

    .summary-list { list-style: none; padding-left: 0; }
    .summary-list li {
      padding: 8px 0 8px 20px;
      position: relative;
      color: #555;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .summary-list li:before {
      content: "â€¢";
      position: absolute;
      left: 5px;
      color: #4a90e2;
      font-weight: bold;
    }

    .qa-section { margin-bottom: 10px; }

    .qa-item {
      margin-bottom: 18px;
      border-left: 3px solid #4a90e2;
      padding-left: 15px;
    }

    .question {
      font-size: 15px;
      font-weight: 600;
      color: #16a085;
      margin-bottom: 10px;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .answer-row{
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .answer-icon{
      flex: 0 0 auto;
      width: 22px;
      line-height: 1.4;
      margin-top: 1px;
    }
    .answer-text{
      flex: 1 1 auto;
      white-space: pre-wrap; /* ê¸°ë³¸ì€ ìœ ì§€(ì „ì²´ ë³´ê¸°ì—ì„œ í•„ìš”) */
    }

    /* âœ… ë¯¸ë¦¬ë³´ê¸° ë°•ìŠ¤ ì»´íŒ©íŠ¸ + ì¤„ìˆ˜ ì œí•œ(ìŠ¤í¬ë¡¤ ì—†ì´) */
    .answer-preview {
      background-color: #e3f2fd;
      padding: 10px 12px;          /* 12x15 -> ì¶•ì†Œ */
      border-radius: 4px;
      font-size: 14px;
      color: #2980b9;
      line-height: 1.45;
      position: relative;
      white-space: normal;         /* pre-wrap ì œê±° */
    }
    .answer-preview .answer-text{
    white-space: pre-line;   /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
    display: block;          /* ìì—° ë†’ì´ */
    overflow: visible;       /* ì•ˆ ì˜ë¦¼ */
    }

    /* ì „ì²´ë³´ê¸°ëŠ” ì›ë˜ëŒ€ë¡œ ì¤„ë°”ê¿ˆ ìœ ì§€ */
    .answer-full {
      display: none;
      margin-top: 10px;
      padding: 15px;
      background-color: #f0f8ff;
      border-radius: 4px;
      font-size: 14px;
      color: #34495e;
      line-height: 1.7;
      white-space: pre-wrap;
    }
    .answer-full .answer-text{ white-space: pre-wrap; }
    .answer-full.show { display: block; }

    .show-more-btn {
      color: #4a90e2;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      margin-top: 8px;
      display: inline-block;
      user-select: none;
    }
    .show-more-btn:hover { text-decoration: underline; }

    .muted { color: #888; font-size: 12px; }

    .loading {
      padding: 18px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      color: #666;
      margin-bottom: 18px;
    }

    @media (max-width: 1200px) {
      .content-area { flex-direction: column; }
      .sidebar { width: 100%; position: static; }
      .search-input { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <nav class="nav">
        <a class="navBtn" href="https://mois-data-internship.onrender.com/" target="_blank" rel="noopener">ì±—ë´‡</a>
        <a class="navBtn" href="/">ëŒ€ì‹œë³´ë“œ</a>
        <a class="navBtn" href="/news">ì˜ˆìƒ ìŸì  ë¸Œë¦¬í•‘</a>
        <a class="navBtn" href="/speech">ë°œì–¸ê²€ìƒ‰</a>
        <!-- âœ… ê¸°ì¤€ ì‹œê°„(ë°œì–¸ê²€ìƒ‰ ì˜†) -->
        <span id="asOf" class="asof"></span>
      </nav>
    </div>

    <div class="header-controls">
      <div class="search-box">
        <input id="q" type="text" class="search-input" placeholder="í‚¤ì›Œë“œ/ì§ˆë¬¸/ë°°ê²½ìœ¼ë¡œ ê²€ìƒ‰" />
        <button id="btnSearch" class="search-btn">ğŸ” ê²€ìƒ‰</button>
      </div>
    </div>
  </div>


  <div class="content-area">
    <div class="main-content">
      <div id="list" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</div>
    </div>

    <div class="sidebar">
      <div class="sidebar-title">ğŸ“Œ ì£¼ìš” ìŸì  ëª©ë¡</div>
      <div id="sideList" class="muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>

      <div class="tag-section">
        <div class="sidebar-title">ğŸ·ï¸ íƒœê·¸</div>
        <div id="tags" class="muted">íƒœê·¸ ìƒì„± ì¤‘â€¦</div>
      </div>
    </div>
  </div>

  <script>
    // ====== helpers ======
    const esc = (s) => String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");

    const formatTs = (ts) => {
      const s = String(ts || '').trim();
      if (!s) return '';
      // ISO(2026-02-12T14:24:54Z) -> 2026-02-12 14:24
      const noZ = s.replace(/Z$/,'');
      const spaced = noZ.replace('T',' ');
      // yyyy-mm-dd hh:mm:ss -> yyyy-mm-dd hh:mm
      return spaced.replace(/(\d{4}-\d{2}-\d{2})\s(\d{2}:\d{2})(?::\d{2}(?:\.\d+)?)?/, '$1 $2');
    };

    const parseTag = (keyword) => {
      // "[ëŒ€í˜• ì°¸ì‚¬] ..." -> "ëŒ€í˜• ì°¸ì‚¬"
      const m = String(keyword || '').match(/^\s*\[([^\]]+)\]/);
      return m ? m[1].trim() : null;
    };

    const toBadgeColor = (qaCount) => {
      // ì ìˆ˜/ê¸´ê¸‰ë„ ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ "Q&A ê°œìˆ˜"ë¡œ ì‹œê°í™”(ê°€ë²¼ìš´ íŒŒìƒì¹˜)
      if (qaCount >= 8) return 'red';
      if (qaCount >= 5) return 'orange';
      return 'green';
    };

    // ====== state ======
    let ISSUES = [];         // [{keyword, qa_count, latest_at, background_preview}]
    let ACTIVE_TAG = null;   // string or null
    let LAST_QUERY = '';

    // ====== fetch ======
    async function fetchIssues(q='') {
      const url = new URL('/api/news/issues', location.origin);
      if (q) url.searchParams.set('q', q);
      const r = await fetch(url.toString());
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    async function fetchIssueDetail(keyword) {
      const url = new URL('/api/news/issue', location.origin);
      url.searchParams.set('keyword', keyword);
      const r = await fetch(url.toString());
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    // ====== render ======
    function renderSidebar(issues) {
      const top = issues.slice(0, 12);
      const side = document.getElementById('sideList');
      if (!top.length) {
        side.innerHTML = '<div class="muted">í‘œì‹œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      side.innerHTML = top.map((x, i) => {
        const id = 'issue_' + (i+1);
        return `
          <div class="sidebar-item" onclick="scrollToIssue('${id}')">
            ${i+1}. ${esc(x.keyword)}
          </div>`;
      }).join('');
    }

    function renderTags(issues) {
      const tagsEl = document.getElementById('tags');
      const tags = {};
      for (const it of issues) {
        const t = parseTag(it.keyword);
        if (t) tags[t] = (tags[t] || 0) + 1;
      }
      const tagList = Object.entries(tags)
        .sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]))
        .slice(0, 20);

      if (!tagList.length) {
        tagsEl.innerHTML = '<div class="muted">íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const pill = (t, c) => `
        <span class="tag ${ACTIVE_TAG===t ? 'active' : ''}" onclick="toggleTag('${esc(t)}')">
          #${esc(t)} <span style="opacity:.75">(${c})</span>
        </span>`;
      tagsEl.innerHTML = `
        <div style="margin-bottom:8px;">
          <span class="tag ${ACTIVE_TAG===null ? 'active' : ''}" onclick="toggleTag('__ALL__')">ì „ì²´</span>
        </div>
        ${tagList.map(([t,c])=>pill(t,c)).join('')}
      `;
    }

    function issueCardHTML(x, idx) {
      const id = 'issue_' + (idx+1);
      const iconId = 'icon_' + (idx+1);
      const subtitle = x.background_preview || '';

      return `
        <div class="issue-card" id="${id}_card">
          <div class="issue-header" onclick="toggleIssue('${id}', '${esc(x.keyword)}', ${idx+1})">
            <div class="issue-title-section">
              <!-- âœ… ì¹´ë“œ ìƒë‹¨ì˜ 'Q&A Nê°œ', ì‹œê°„ ë°°ì§€ ì œê±° -->
              <div class="issue-meta"></div>

              <div class="issue-title">${esc(x.keyword)}</div>
              <div class="issue-subtitle">${esc(subtitle)}</div>
            </div>
            <div class="expand-icon" id="${iconId}">â–¼</div>
          </div>
          <div class="issue-body" id="${id}">
            <div class="loading">ìƒì„¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</div>
          </div>
        </div>
      `;
    }

    function renderMain(issues) {
      const list = document.getElementById('list');
      if (!issues.length) {
        list.className = '';
        list.innerHTML = `<div class="loading">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      list.className = '';
      list.innerHTML = issues.map(issueCardHTML).join('');
    }

    function makeSummaryBullets(background) {
      const s = String(background || '').trim();
      if (!s) return [];
      // ì¤„ ë‹¨ìœ„ë¡œ "- "ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ìš°ì„  ì‚¬ìš©
      const lines = s.split('\n').map(x=>x.trim()).filter(Boolean);
      const bullets = [];
      for (const ln of lines) {
        const cleaned = ln.replace(/^\-\s*/, '').trim();
        if (cleaned) bullets.push(cleaned);
      }
      // ë„ˆë¬´ ê¸¸ë©´ ì•ë¶€ë¶„ë§Œ
      return bullets.slice(0, 12);
    }

    function qaHTML(rows, baseIdx) {
      // rows: [{question,answer,background,created_at,...}]
      return rows.map((r, i) => {
        const q = String(r.question || '').trim();
        const a = String(r.answer || '').trim();
        const preview = a.length > 180 ? (a.slice(0, 180) + 'â€¦') : a;
        const ansId = `ans_${baseIdx}_${i+1}`;

        return `
          <div class="qa-item">
            <div class="question">${esc(q || '(ì§ˆë¬¸ ì—†ìŒ)')}</div>

            <div class="answer-preview">
              <div class="answer-row">
                <div class="answer-icon">ğŸ’¬</div>
                <div class="answer-text">${esc(preview || '(ë‹µë³€ ì—†ìŒ)')}</div>
              </div>

              ${a.length > 180 ? `<div class="show-more-btn" onclick="toggleAnswer('${ansId}', event)">ìì„¸íˆ ë³´ê¸° â–¼</div>` : ``}
              <div class="answer-full" id="${ansId}">
                <div class="answer-row">
                  <div class="answer-icon">ğŸ’¬</div>
                  <div class="answer-text">${esc(a)}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }


    async function renderDetailInto(issueId, keyword, idx) {
      const body = document.getElementById(issueId);
      if (!body) return;

      try {
        const rows = await fetchIssueDetail(keyword);
        if (!rows.length) {
          body.innerHTML = `<div class="muted">ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          return;
        }

        const bg = rows[0].background || '';
        const bullets = makeSummaryBullets(bg);

        body.innerHTML = `
          <div class="summary-section">
            <div class="section-title"><span class="section-icon">ğŸ’¡</span> ìŸì  ìš”ì•½</div>
            ${bullets.length
              ? `<ul class="summary-list">${bullets.map(x=>`<li>${esc(x)}</li>`).join('')}</ul>`
              : `<div class="muted">ìš”ì•½ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`
            }
          </div>

          <div class="qa-section">
            <div class="section-title"><span class="section-icon">â“</span> ì˜ˆìƒ ì§ˆì˜ ë° ë‹µë³€</div>
            ${qaHTML(rows, idx)}
          </div>
        `;
      } catch (e) {
        body.innerHTML = `<div class="muted">ìƒì„¸ ë¡œë”© ì‹¤íŒ¨: ${esc(e.message || e)}</div>`;
      }
    }

    // ====== interactions ======
    function toggleIssue(issueId, keyword, idx) {
      const body = document.getElementById(issueId);
      const icon = document.getElementById('icon_' + idx);
      if (!body || !icon) return;

      const isExpanded = body.classList.contains('expanded');
      if (isExpanded) {
        body.classList.remove('expanded');
        icon.classList.remove('expanded');
        return;
      }
      body.classList.add('expanded');
      icon.classList.add('expanded');

      // ì•„ì§ ìƒì„¸ë¥¼ ë¡œë”©í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¡œë”©
      if (body.dataset.loaded !== '1') {
        body.dataset.loaded = '1';
        renderDetailInto(issueId, keyword, idx);
      }
    }

    function toggleAnswer(id, ev) {
      if (ev) ev.stopPropagation();
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle('show');
    }

    function scrollToIssue(issueId) {
      const card = document.getElementById(issueId + '_card');
      if (!card) return;
      card.scrollIntoView({behavior:'smooth', block:'start'});
      // ìë™ìœ¼ë¡œ í¼ì¹˜ê¸°
      const body = document.getElementById(issueId);
      if (body && !body.classList.contains('expanded')) {
        // keywordëŠ” DOMì—ì„œ ë‹¤ì‹œ ë½‘ìŒ
        const title = card.querySelector('.issue-title');
        const keyword = title ? title.textContent : '';
        const idx = Number(issueId.split('_')[1] || '1');
        toggleIssue(issueId, keyword, idx);
      }
    }

    function toggleTag(tag) {
      if (tag === '__ALL__') ACTIVE_TAG = null;
      else ACTIVE_TAG = (ACTIVE_TAG === tag ? null : tag);
      applyFiltersAndRender();
    }

    function applyFiltersAndRender() {
      let items = ISSUES.slice();

      if (ACTIVE_TAG) {
        items = items.filter(x => parseTag(x.keyword) === ACTIVE_TAG);
      }

      items.sort((a,b) => String(b.latest_at||'').localeCompare(String(a.latest_at||'')));

      renderMain(items);
      renderSidebar(items);
      renderTags(ISSUES); // íƒœê·¸ëŠ” ì „ì²´ ê¸°ì¤€(ì˜ë„ì ìœ¼ë¡œ ê³ ì •)
    }

    async function init() {
      const input = document.getElementById('q');
      const btn = document.getElementById('btnSearch');

      const runSearch = async () => {
        const q = (input.value || '').trim();
        LAST_QUERY = q;
        document.getElementById('list').className = 'loading';
        document.getElementById('list').innerText = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦';
        try {
          const issues = await fetchIssues(q);
          // ìµœì‹ ìˆœ ì •ë ¬(ë°±ì—”ë“œì—ì„œ ì •ë ¬ë˜ì–´ ì˜¤ì§€ë§Œ ì•ˆì „)
          issues.sort((a,b) => String(b.latest_at||'').localeCompare(String(a.latest_at||'')));
          ISSUES = issues;
          ACTIVE_TAG = null;

          /* âœ… ìƒë‹¨ 'ê¸°ì¤€: YYYY-MM-DD HH:MM' í‘œì‹œ(ë°œì–¸ê²€ìƒ‰ ì˜†) */
          const asOfEl = document.getElementById('asOf');
          if (asOfEl){
            const ts = (issues && issues.length && issues[0].latest_at) ? formatTs(issues[0].latest_at) : "";
            asOfEl.textContent = ts ? `ê¸°ì¤€: ${ts}` : "";
          }

          applyFiltersAndRender();
        } catch (e) {
          const list = document.getElementById('list');
          list.className = '';
          list.innerHTML = `<div class="loading">ë¡œë”© ì‹¤íŒ¨: ${esc(e.message || e)}</div>`;
        }
      };

      btn.addEventListener('click', runSearch);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') runSearch();
      });

      await runSearch();
    }

    init();
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let p = location.pathname.replace(/\/+$/,'') || "/";
      if (p === "/") p = "/dashboard";
      document.querySelectorAll(".navBtn").forEach(a=>{
        const href = (a.getAttribute("href")||"").replace(/\/+$/,'');
        if (!href.startsWith("http") && href === p) a.classList.add("active");
      });
    });
  </script>

</body>
</html>